<!-- FILE: src/app/admin/product-upload.component.html -->

<div class="admin-container">
  <h2>üõí Product Upload & Edit</h2>



  <!-- Load / Clear -->
  <section class="card">
    <h3>Load / Edit Product</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input #pidInput placeholder="Enter product id to load (e.g. 12345)" />
      <button class="btn-primary" (click)="loadProductById(pidInput.value)">Load Product</button>
      <button class="btn-outline" (click)="clearForm()">Clear</button>
      <button class="btn-outline" (click)="goBack()" style="margin-top:4px">‚Üê Back to Products</button>
    </div>

    <div *ngIf="createdProductId" style="margin-top:8px">
      <small>Editing Product ID: <strong>{{ createdProductId }}</strong></small>
    </div>
  </section>

  <!-- Product meta -->
  <section class="card" style="height:80vh">
    <h3>Product Details</h3>
    <form [formGroup]="productForm" (ngSubmit)="$event.preventDefault()" class="form-grid">
      <label>Product Name
        <input formControlName="name" placeholder="e.g. Cotton Polo T-shirt ‚Äî Navy" />
      </label>

      <label>Description
        <textarea formControlName="description" rows="2" placeholder="Short product description (features, material, care)"></textarea>
      </label>

      <label>Categories</label>
      <ng-select formControlName="categoryIds"
                 [items]="categories"
                 bindLabel="name"
                 bindValue="id"
                 [multiple]="true"
                 [closeOnSelect]="false"
                 [searchable]="true"
                 placeholder="Select categories">
      </ng-select>
    </form>
  </section>

  <!-- Images -->
  <section class="card">
    <h3>Images</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <label for="addFiles" class="btn-primary" style="cursor:pointer;padding:6px 10px;border-radius:6px;">Ôºã Add Images</label>
      <input id="addFiles" type="file" multiple hidden (change)="onFilesSelected($event)" />
      <button class="btn-primary" (click)="uploadImagesManual()" [disabled]="uploading || !createdProductId || !selectedFiles.length">Upload Selected</button>
    </div>

    <!-- previews -->
    <div *ngIf="selectedFiles?.length" style="margin-bottom:12px">
      <h4>Selected (preview only)</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div *ngFor="let s of selectedFiles; let i = index" style="position:relative;display:inline-block;margin:6px">
          <button (click)="removePreview(i)" title="Remove preview" style="position:absolute;top:4px;right:4px;border-radius:50%;width:26px;height:26px;border:none;background:#fff;z-index:2">√ó</button>
          <img [src]="s.preview" alt="preview" style="display:block;max-width:140px;max-height:140px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.15)" />
          <small style="display:block;text-align:center;margin-top:4px">{{ s.file.name }}</small>
        </div>
      </div>
    </div>

    <!-- server images -->
    <div class="thumbs" *ngIf="uploadedImages?.length">
      <h4>Uploaded Images</h4>
      <div class="thumb-row">
        <div class="thumb" *ngFor="let img of uploadedImages; let i=index" style="position:relative;display:inline-block;margin:6px">
          <button (click)="deleteImage(img)" title="Delete image" style="position:absolute;top:4px;right:4px;z-index:2;border-radius:50%;width:26px;height:26px;border:none;background:#fff">√ó</button>
          <img [src]="img.src ?? img.ImageUrl ?? img.imageUrl ?? img.url ?? img.path ?? img" alt="img" style="display:block;max-width:140px;max-height:140px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.15)" />
          <small style="display:block;text-align:center;margin-top:4px">{{ img.filename ?? img.name ?? (img.Id ? ('ID: '+img.Id) : '') }}</small>
        </div>
      </div>
    </div>
  </section>

  <!-- Variants -->
  <section class="card">
    <h3>Variants</h3>
    <div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:8px">
      <button class="btn-primary" (click)="addVariantRow()">Ôºã Add</button>
      <button class="btn-outline" (click)="variants=[]">Clear All</button>
    </div>

    <div *ngIf="variants?.length">
      <table class="variants-table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Variant Name</th>
            <th>Attributes</th>
            <th>Stock</th>
            <th>Customer ‚Çπ</th>
            <th>Retailer ‚Çπ</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let v of variants; let i = index">
            <td data-label="SKU">
              <input class="variant-input" [(ngModel)]="v.sku" name="sku-{{i}}" placeholder="e.g. SKU-001" />
            </td>
            <td data-label="Variant Name">
              <input class="variant-input" [(ngModel)]="v.variantName" name="variantName-{{i}}" placeholder="Variant name (e.g. Navy / L)" />
            </td>
            <td data-label="Attributes">
              <input class="variant-input" [(ngModel)]="v.attributes" name="attributes-{{i}}" placeholder="color:Red;size:L (semicolon separated)" />
            </td>
            <td data-label="Stock">
              <input class="variant-input" type="number" [(ngModel)]="v.stockQty" name="stockQty-{{i}}" placeholder="0" />
            </td>
            <td data-label="Customer ‚Çπ">
              <input class="variant-input" type="number" [(ngModel)]="v.customerPrice" name="customerPrice-{{i}}" placeholder="e.g. 499.00" />
            </td>
            <td data-label="Retailer ‚Çπ">
              <input class="variant-input" type="number" [(ngModel)]="v.retailerPrice" name="retailerPrice-{{i}}" placeholder="e.g. 450.00" />
            </td>
            <td class="actions-cell" data-label="Actions" style="vertical-align:middle">
              <div class="variant-actions">
                <button class="btn-primary" (click)="addVariantRow(v)">Duplicate</button>
                <button class="btn-warning" (click)="removeVariantRow(i)">Remove</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="!variants?.length" style="color:#777;margin-top:8px">No variants yet ‚Äî click "Add Variant Row" to start.</div>
  </section>

  <!-- Size Charts Section - ALWAYS SHOW THIS -->
  <section class="card">
    <h3>Size Charts</h3>
    
    <!-- Show when no charts available -->
    <div *ngIf="availableSizeCharts.length === 0" style="background: #f8f9fa; padding: 16px; border-radius: 6px; text-align: center;">
      <p style="color: #666; margin-bottom: 16px;">No size charts available.</p>
      <button class="btn-primary" (click)="createTestSizeChart()">Create Test Size Chart</button>
      <button class="btn-outline" (click)="loadSizeCharts()" style="margin-left: 8px;">Refresh</button>
    </div>

    <!-- Show when charts are available -->
    <div *ngIf="availableSizeCharts.length > 0">
      <p class="muted">Assign size charts to this product</p>

      <div class="size-charts-selection">
        <div *ngFor="let chart of availableSizeCharts" class="size-chart-option">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [value]="chart.id"
                [checked]="selectedSizeCharts.includes(chart.id!)" 
              (change)="onSizeChartSelect(chart.id!, $event)">
            <strong>{{ chart.name }}</strong> - {{ chart.chartType }}
          </label>
          
          <div *ngIf="selectedSizeCharts.includes(chart.id!)" class="primary-option">
            <label class="radio-label">
              <input
                type="radio"
                name="primarySizeChart"
                [value]="chart.id"
                [checked]="primarySizeChartId === chart.id"
                (change)="setPrimarySizeChart(chart.id!)">
              <span class="radiomark"></span>
              Set as Primary
            </label>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button 
          type="button" 
          (click)="assignSizeChartsToProduct()" 
          [disabled]="selectedSizeCharts.length === 0 || !createdProductId"
          class="btn btn-primary" style="color:black;">
          Assign Size Charts to Product
        </button>
        <small *ngIf="!createdProductId" style="color: #dc3545; margin-left: 12px;">
          * Create or load a product first
        </small>
      </div>
    </div>
  </section>

  <!-- Final submit -->
  <section class="card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:flex-end">
      <button class="btn-primary" (click)="submitFinal()" [disabled]="processing">
        {{ processing ? (isEditMode ? 'Saving...' : 'Creating...') : (isEditMode ? 'Save Changes' : 'Create Product') }}
      </button>
    </div>
  </section>
</div>