<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-shopping-bag me-2"></i>Order Management</h2>
        <div class="text-muted">
          Total: {{ totalOrders }} orders
        </div>
      </div>
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h4>{{ stats.total }}</h4>
                  <p class="mb-0">Total Orders</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-shopping-bag fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card text-white bg-warning">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h4>{{ stats.pending }}</h4>
                  <p class="mb-0">Pending</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-clock fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card text-white bg-info">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h4>{{ stats.confirmed }}</h4>
                  <p class="mb-0">Confirmed</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-check-circle fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card text-white bg-success">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h4>{{ stats.delivered }}</h4>
                  <p class="mb-0">Delivered</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-truck fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card text-white bg-danger">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h4>{{ stats.cancelled }}</h4>
                  <p class="mb-0">Cancelled</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-times-circle fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card text-white bg-dark">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h4>₹{{ stats.revenue | number }}</h4>
                  <p class="mb-0">Revenue</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-rupee-sign fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Order Status</label>
              <select class="form-select" [(ngModel)]="statusFilter" (change)="onFilterChange()">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="CONFIRMED">Confirmed</option>
                <option value="PROCESSING">Processing</option>
                <option value="SHIPPED">Shipped</option>
                <option value="DELIVERED">Delivered</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Status</label>
              <select class="form-select" [(ngModel)]="paymentStatusFilter" (change)="onFilterChange()">
                <option value="">All Payment Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="PAID">Paid</option>
                <option value="FAILED">Failed</option>
                <option value="REFUNDED">Refunded</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">User ID</label>
              <input type="number" class="form-control" [(ngModel)]="userIdFilter" 
                     placeholder="Filter by User ID" (input)="onFilterChange()">
            </div>
            
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-outline-secondary w-100" (click)="loadOrders()" [disabled]="loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                <i class="fas fa-sync-alt me-2"></i>Refresh
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading orders...</p>
      </div>

      <!-- Orders List -->
      <div *ngIf="!loading">
        <div *ngIf="orders.length === 0" class="alert alert-info text-center">
          <i class="fas fa-box-open fa-2x mb-3 text-muted"></i>
          <h5>No orders found</h5>
          <p>No orders match your filters.</p>
        </div>

        <div *ngFor="let order of orders" class="card mb-3 order-card">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-2">
                <div class="d-flex align-items-center">
                  <div class="order-icon me-3">
                    <i class="fas fa-box text-primary"></i>
                  </div>
                  <div>
                    <strong class="d-block">#{{ getOrderNumber(order) }}</strong>
                    <small class="text-muted">
                      {{ getCreatedAt(order) | date:'medium' }}
                    </small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-2">
                <span class="badge" [ngClass]="getStatusBadgeClass(getStatus(order))">
                  {{ getStatus(order) }}
                </span>
              </div>
              
              <div class="col-md-2">
                <span class="badge" [ngClass]="getPaymentStatusBadgeClass(getPaymentStatus(order))">
                  {{ getPaymentStatus(order) }}
                </span>
              </div>
              
              <div class="col-md-2">
                <strong class="text-success">₹{{ getTotalAmount(order) | number }}</strong>
                <div class="text-muted small">
                  {{ getItemsCount(order) }} items
                </div>
              </div>
              
              <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary btn-sm me-2"
                        (click)="openStatusUpdate(order)">
                  <i class="fas fa-edit me-1"></i>Update Status
                </button>
                
                <a [routerLink]="['/order-details', getOrderId(order)]" 
                   class="btn btn-outline-info btn-sm me-2">
                  <i class="fas fa-eye me-1"></i>Details
                </a>

                <a [routerLink]="['/payment-history']" 
                   [queryParams]="{userId: order.user?.id}"
                   class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-credit-card me-1"></i>Payments
                </a>
              </div>
            </div>
            
            <!-- User info -->
            <div *ngIf="order.user" class="mt-2 pt-2 border-top">
              <small class="text-muted">
                <i class="fas fa-user me-1"></i>
                Customer: {{ order.user.name }} ({{ order.user.email }}) - ID: {{ order.user.id }}
              </small>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <nav *ngIf="totalPages > 1" aria-label="Order pagination">
          <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="page === 1">
              <button class="page-link" (click)="onPageChange(page - 1)" [disabled]="page === 1">
                <i class="fas fa-chevron-left"></i> Previous
              </button>
            </li>
            
            <li *ngFor="let p of getPages()" 
                class="page-item" 
                [class.active]="page === p">
              <button class="page-link" (click)="onPageChange(p)">{{ p }}</button>
            </li>
            
            <li class="page-item" [class.disabled]="page === totalPages">
              <button class="page-link" (click)="onPageChange(page + 1)" [disabled]="page === totalPages">
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div *ngIf="selectedOrder" class="modal fade show d-block" style="background: rgba(0,0,0,0.5)">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Order Status</h5>
        <button type="button" class="btn-close" (click)="selectedOrder = null"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Order #{{ getOrderNumber(selectedOrder) }}</label>
          <p class="text-muted mb-2">Customer: {{ selectedOrder.user?.name }}</p>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Current Status</label>
          <div>
            <span class="badge" [ngClass]="getStatusBadgeClass(getStatus(selectedOrder))">
              {{ getStatus(selectedOrder) }}
            </span>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">New Status</label>
          <select class="form-select" [(ngModel)]="newStatus">
            <option value="PENDING">Pending</option>
            <option value="CONFIRMED">Confirmed</option>
            <option value="PROCESSING">Processing</option>
            <option value="SHIPPED">Shipped</option>
            <option value="DELIVERED">Delivered</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Notes (Optional)</label>
          <textarea class="form-control" [(ngModel)]="statusNotes" 
                    placeholder="Add any notes about this status change..." rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="selectedOrder = null">Cancel</button>
        <button type="button" class="btn btn-primary" 
                (click)="updateOrderStatus()"
                [disabled]="!newStatus || updatingStatus[getOrderId(selectedOrder)]">
          <span *ngIf="updatingStatus[getOrderId(selectedOrder)]" 
                class="spinner-border spinner-border-sm me-2"></span>
          Update Status
        </button>
      </div>
    </div>
  </div>
</div>