{
  "info": {
    "name": "SivanyaShop - Auth & Razorpay Verify (Test)",
    "_postman_id": "sivanyashop-razorpay-verify-collection",
    "description": "Use this collection to login and test POST /api/payments/verify. Set environment variables described below.\n\nENVIRONMENT VARIABLES you must create in Postman (Local environment):\n - adminToken : (will be populated by Login response)\n - rz_order_id : e.g. order_RXxecLVST47nVO\n - rz_payment_id : e.g. pay_RXxerNtU81Lw4U\n - rz_secret : your RAZORPAY_KEY_SECRET (keep private in Postman environment)\n\nFlow:\n 1) Auth - Login -> sets adminToken\n 2) Payments - Verify -> pre-request computes razorpay_signature from rz_order_id|rz_payment_id using rz_secret and posts verify body\n\n**Do NOT store rz_secret in shared/public places.**",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auth - Login",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"admin@example.com\",\n  \"password\": \"adminpassword\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "login"]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// After login: store token into environment variable 'adminToken' so subsequent requests use it.",
              "try {",
              "  const res = pm.response.json();",
              "  if (res && res.token) {",
              "    pm.environment.set('adminToken', res.token);",
              "    console.log('/* PUT LOG HERE */ Stored adminToken in environment');",
              "  } else {",
              "    console.warn('Login did not return token in response.');",
              "  }",
              "} catch (e) { console.error('Login response parse error', e); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Payments - Verify",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{adminToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"razorpay_order_id\": \"{{rz_order_id}}\",\n  \"razorpay_payment_id\": \"{{rz_payment_id}}\",\n  \"razorpay_signature\": \"{{razorpay_signature}}\",\n  \"cartItems\": [\n    {\n      \"productId\": 23,\n      \"price\": 10,\n      \"qty\": 1,\n      \"productName\": \"Pen\"\n    }\n  ],\n  \"shippingAddressId\": 123,\n  \"retailerId\": 1\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/payments/verify",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "payments", "verify"]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Pre-request: compute razorpay_signature HMAC-SHA256 of `${orderId}|${paymentId}` using rz_secret",
              "// Requires you to set 'rz_order_id', 'rz_payment_id', and 'rz_secret' in your Postman environment.",
              "",
              "const orderId = pm.environment.get('rz_order_id');",
              "const paymentId = pm.environment.get('rz_payment_id');",
              "const secret = pm.environment.get('rz_secret');",
              "",
              "if (!orderId || !paymentId) {",
              "  console.warn('rz_order_id or rz_payment_id environment variable is missing');",
              "}",
              "if (!secret) {",
              "  console.warn('rz_secret (RAZORPAY_KEY_SECRET) is not set in environment. Signature cannot be computed.');",
              "}",
              "",
              "if (orderId && paymentId && secret) {",
              "  // CryptoJS is available in Postman sandbox",
              "  const CryptoJS = require('crypto-js');",
              "  const toSign = `${orderId}|${paymentId}`;",
              "  const hmac = CryptoJS.HmacSHA256(toSign, secret).toString(CryptoJS.enc.Hex);",
              "  pm.environment.set('razorpay_signature', hmac);",
              "  console.log('/* PUT LOG HERE */ pre-request computed signature:', hmac);",
              "} else {",
              "  pm.environment.unset('razorpay_signature');",
              "}"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 200 or 400 (expected)', function() {",
              "  pm.expect(pm.response.code).to.be.oneOf([200,201,400]);",
              "});",
              "",
              "// Log response body to console for debugging",
              "try { console.log('Verify response:', pm.response.json()); } catch(e) { console.log('Non-json response or empty'); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    }
  ]
}
